FROM golang:1.10.2-alpine

COPY generate_and_start_telegrafs_test.sh /generate_and_start_telegrafs.sh
RUN chmod +x /generate_and_start_telegrafs.sh

WORKDIR /

RUN apk update
RUN apk add git python py-pip make bash nodejs

RUN pip install requests influxdb awscli

RUN npm config set unsafe-perm true
RUN npm i -g pm2@latest

RUN go get 'github.com/kontaktio/telegraf'
RUN go get -u github.com/golang/dep/...

RUN mv /go/src/github.com/kontaktio /go/src/github.com/influxdata
WORKDIR /go/src/github.com/influxdata/telegraf
RUN git checkout develop

RUN make

RUN touch /var/log/telegraf-config-gen.log
RUN mkdir /etc/telegraf

CMD /bin/bash /generate_and_start_telegrafs.sh
